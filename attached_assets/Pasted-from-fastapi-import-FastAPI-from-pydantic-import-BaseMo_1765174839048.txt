from fastapi import FastAPI
from pydantic import BaseModel
import numpy as np
import uvicorn
import re
# –£–¥–∞–ª–µ–Ω—ã –∏–º–ø–æ—Ä—Ç—ã Matplotlib, io, base64

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ FastAPI ---
app = FastAPI()

# –ú–æ–¥–µ–ª—å –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–æ–∂–∏–¥–∞–µ–º —Å—Ç—Ä–æ–∫—É —Å Q –∏ H)
class PumpData(BaseModel):
    raw_text: str

@app.get("/")
def home():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Ä–∞–±–æ—Ç—ã API."""
    return {"status": "RusPump HQ-Chart API (Cubic Poly Text Output) is running"}

@app.post("/calculate_poly")
def calculate_poly(data: PumpData):
    """–ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Å—Ç—Ä–æ–∫—É –¥–∞–Ω–Ω—ã—Ö, –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Ä–∞—Å—á–µ—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON —Å —Ñ–æ—Ä–º—É–ª–∞–º–∏."""
    try:
        # 1. –ü–ê–†–°–ò–ù–ì –í–•–û–î–ù–´–• –î–ê–ù–ù–´–•
        numbers = [float(s) for s in re.findall(r'-?\d+\.?\d*', data.raw_text)]
        
        if len(numbers) < 8 or len(numbers) % 2 != 0:
            return {"error": "–û—à–∏–±–∫–∞: –î–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –∫—É–±–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–ª–∏–Ω–æ–º–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è –º–∏–Ω–∏–º—É–º 4 –ø–∞—Ä—ã —á–∏—Å–µ–ª (Q H)."}

        q_user = np.array(numbers[0::2]) # Q (–†–∞—Å—Ö–æ–¥)
        h_user = np.array(numbers[1::2]) # H (–ù–∞–ø–æ—Ä)

        # --- –ù–û–í–´–ô –†–ê–°–ß–ï–¢: Qmin –∏ Qmax ---
        q_min = np.min(q_user)
        q_max = np.max(q_user)
        # ----------------------------------

        # 2. –ú–ê–¢–ï–ú–ê–¢–ò–ö–ê (–ü–æ–ª–∏–Ω–æ–º 3-–π —Å—Ç–µ–ø–µ–Ω–∏)
        coefficients = np.polyfit(q_user, h_user, 3)
        poly_func = np.poly1d(coefficients)
        a, b, c, d = coefficients # a=Q^3, b=Q^2, c=Q^1, d=Q^0

        # –†–∞—Å—á–µ—Ç R^2 (–¢–æ—á–Ω–æ—Å—Ç–∏)
        h_pred = poly_func(q_user)
        y_mean = np.mean(h_user)
        ss_tot = np.sum((h_user - y_mean)**2)
        ss_res = np.sum((h_user - h_pred)**2)
        r_squared = 1.0 if ss_tot == 0 else 1 - (ss_res / ss_tot)
        
        # --- –£–î–ê–õ–ï–ù –ë–õ–û–ö –ì–ï–ù–ï–†–ê–¶–ò–ò –ì–†–ê–§–ò–ö–ê –ò BASE64 ---
        
        # 3. –§–û–†–ú–ò–†–û–í–ê–ù–ò–ï –¢–ï–ö–°–¢–ê –û–¢–í–ï–¢–ê (–§–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç)
        quality_emoji = "‚úÖ" if r_squared > 0.98 else "‚ö†Ô∏è" if r_squared > 0.9 else "‚ùå"
        # –£–ª—É—á—à–µ–Ω–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ —É—Ä–∞–≤–Ω–µ–Ω–∏—è
        sb = "+" if b >= 0 else ""
        sc = "+" if c >= 0 else ""
        sd = "+" if d >= 0 else ""
        visual_eq = f"H(Q) = {a:.5f}Q¬≥ {sb}{b:.5f}Q¬≤ {sc}{c:.5f}Q {sd}{d:.2f}"

        # --- –ë–õ–û–ö: –í—ã–≤–æ–¥ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ A0, A1, A2, A3 ---
        coefficients_list = (
            f"üìà *–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –ø–æ–ª–∏–Ω–æ–º–∞ (A0 - A3):*\n"
            f"A0 (–ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞) = `{d:.10f}`\n"  # A0 = d
            f"A1 (Q)         = `{c:.10f}`\n"  # A1 = c
            f"A2 (Q¬≤)        = `{b:.10f}`\n"  # A2 = b
            f"A3 (Q¬≥)        = `{a:.10f}`"   # A3 = a
        )

        return {
            # –ë–æ–ª—å—à–µ –Ω–µ—Ç image_base64
            "message": (
                f"üìä *–†–∞—Å—á–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω (–¢–µ–∫—Å—Ç–æ–≤—ã–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç RusPump):*\n"
                f"{quality_emoji} **–¢–æ—á–Ω–æ—Å—Ç—å (R¬≤):** {r_squared*100:.2f}%\n"
                f"üíß **–†–∞–±–æ—á–∏–π –¥–∏–∞–ø–∞–∑–æ–Ω Q:** {q_min:.2f} –º¬≥/—á –¥–æ {q_max:.2f} –º¬≥/—á\n\n"
                f"`{visual_eq}`\n\n"
                f"{coefficients_list}" 
            )
        }

    except Exception as e:
        # –í–æ–∑–≤—Ä–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ
        return {"error": f"–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Ä–∞—Å—á–µ—Ç. {str(e)}"}

# --- –ó–ê–ü–£–°–ö –°–ï–†–í–ï–†–ê ---
if __name__ == "__main__":
    uvicorn.run(app, host="0.0.0.0", port=5000)
