from fastapi import FastAPI
from pydantic import BaseModel
import numpy as np
import uvicorn
import re
import matplotlib
# –§–ò–ö–° –°–¢–ê–ë–ò–õ–¨–ù–û–°–¢–ò: –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã Matplotlib –Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞—Ö (Render, Yandex, Replit)
matplotlib.use('Agg') 
import matplotlib.pyplot as plt
import io
import base64

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ FastAPI ---
app = FastAPI()

# –ú–æ–¥–µ–ª—å –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–æ–∂–∏–¥–∞–µ–º —Å—Ç—Ä–æ–∫—É —Å Q –∏ H)
class PumpData(BaseModel):
    raw_text: str

@app.get("/")
def home():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Ä–∞–±–æ—Ç—ã API."""
    return {"status": "RusPump HQ-Chart API (Cubic Poly + Graph) is running"}

@app.post("/calculate_poly")
def calculate_poly(data: PumpData):
    """–ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Å—Ç—Ä–æ–∫—É –¥–∞–Ω–Ω—ã—Ö –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON —Å —Ñ–æ—Ä–º—É–ª–æ–π –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º."""
    try:
        # 1. –ü–ê–†–°–ò–ù–ì –í–•–û–î–ù–´–• –î–ê–ù–ù–´–•
        numbers = [float(s) for s in re.findall(r'-?\d+\.?\d*', data.raw_text)]
        
        if len(numbers) < 8 or len(numbers) % 2 != 0:
            return {"error": "–û—à–∏–±–∫–∞: –î–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –∫—É–±–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–ª–∏–Ω–æ–º–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è –º–∏–Ω–∏–º—É–º 4 –ø–∞—Ä—ã —á–∏—Å–µ–ª (Q H)."}

        q_user = np.array(numbers[0::2]) # Q (–†–∞—Å—Ö–æ–¥)
        h_user = np.array(numbers[1::2]) # H (–ù–∞–ø–æ—Ä)

        # 2. –ú–ê–¢–ï–ú–ê–¢–ò–ö–ê (–ü–æ–ª–∏–Ω–æ–º 3-–π —Å—Ç–µ–ø–µ–Ω–∏)
        coefficients = np.polyfit(q_user, h_user, 3)
        poly_func = np.poly1d(coefficients)
        a, b, c, d = coefficients # a=Q^3, b=Q^2, c=Q^1, d=Q^0

        # –†–∞—Å—á–µ—Ç R^2 (–¢–æ—á–Ω–æ—Å—Ç–∏)
        h_pred = poly_func(q_user)
        y_mean = np.mean(h_user)
        ss_tot = np.sum((h_user - y_mean)**2)
        ss_res = np.sum((h_user - h_pred)**2)
        r_squared = 1.0 if ss_tot == 0 else 1 - (ss_res / ss_tot)
        
        # 3. –ì–ï–ù–ï–†–ê–¶–ò–Ø –ì–†–ê–§–ò–ö–ê (–°—Ç–∞–Ω–¥–∞—Ä—Ç RusPump)
        
        # --- –§–ò–ö–°–ê–¶–ò–Ø –°–¢–ê–ù–î–ê–†–¢–ê: –î–ò–ê–ü–ê–ó–û–ù –°–¢–†–û–ì–û –û–¢ Qmin –î–û Qmax ---
        q_min_plot = np.min(q_user)
        q_max_plot = np.max(q_user)
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º 100 —Ç–æ—á–µ–∫ —Å—Ç—Ä–æ–≥–æ –º–µ–∂–¥—É Qmin –∏ Qmax
        q_smooth = np.linspace(q_min_plot, q_max_plot, 100)
        h_smooth = poly_func(q_smooth)
        
        plt.figure(figsize=(10, 6))
        
        # –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è 
        plt.plot(q_smooth, h_smooth, 'b-', label='–ê–ø–ø—Ä–æ–∫—Å–∏–º–∞—Ü–∏—è (–ü–æ–ª–∏–Ω–æ–º 3 —Å—Ç.)', linewidth=2)
        plt.plot(q_user, h_user, 'ro', label='–ò—Å—Ö–æ–¥–Ω—ã–µ —Ç–æ—á–∫–∏', markersize=8)
        
        # –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ
        plt.title(f"–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ –Ω–∞—Å–æ—Å–∞ Q-H (R¬≤={r_squared:.4f})")
        plt.xlabel("–†–∞—Å—Ö–æ–¥ Q, –º¬≥/—á")
        plt.ylabel("–ù–∞–ø–æ—Ä H, –º")
        plt.grid(True, which='both', linestyle='--')
        plt.legend()
        
        # --- –§–ò–ö–°–ê–¶–ò–Ø –û–°–ï–ô: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞—á–∞–ª–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤ (0, 0) ---
        plt.xlim(xmin=0) # –û—Å—å Q –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å—Ç—Ä–æ–≥–æ —Å 0
        plt.ylim(ymin=0) # –û—Å—å H –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å—Ç—Ä–æ–≥–æ —Å 0
        
        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –≤ Base64
        buf = io.BytesIO()
        plt.savefig(buf, format='png')
        plt.close() # –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ñ–∏–≥—É—Ä—É
        
        image_base64 = base64.b64encode(buf.read()).decode('utf-8')

        # 4. –§–û–†–ú–ò–†–û–í–ê–ù–ò–ï –¢–ï–ö–°–¢–ê –û–¢–í–ï–¢–ê (–°—Ç–∞–Ω–¥–∞—Ä—Ç RusPump)
        quality_emoji = "‚úÖ" if r_squared > 0.98 else "‚ö†Ô∏è" if r_squared > 0.9 else "‚ùå"
        # –£–ª—É—á—à–µ–Ω–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ —É—Ä–∞–≤–Ω–µ–Ω–∏—è
        sb = "+" if b >= 0 else ""
        sc = "+" if c >= 0 else ""
        sd = "+" if d >= 0 else ""
        visual_eq = f"H(Q) = {a:.5f}Q¬≥ {sb}{b:.5f}Q¬≤ {sc}{c:.5f}Q {sd}{d:.2f}"

        # --- –ë–õ–û–ö: –í—ã–≤–æ–¥ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ A0, A1, A2, A3 ---
        coefficients_list = (
            f"üìà *–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –ø–æ–ª–∏–Ω–æ–º–∞ (A0 - A3):*\n"
            f"A0 (–ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞) = `{d:.10f}`\n"  # A0 = d
            f"A1 (Q)         = `{c:.10f}`\n"  # A1 = c
            f"A2 (Q¬≤)        = `{b:.10f}`\n"  # A2 = b
            f"A3 (Q¬≥)        = `{a:.10f}`"   # A3 = a
        )
        
        # --- –í–ê–ñ–ù–û: –§–æ—Ä–º—É–ª—ã Excel —Ç–µ–ø–µ—Ä—å –Ω–µ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ---
        
        return {
            "image_base64": image_base64,
            "message": (
                f"üìà *–†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å—á–µ—Ç–∞:*\n`{visual_eq}`\n"
                f"{quality_emoji} **–¢–æ—á–Ω–æ—Å—Ç—å (R¬≤):** {r_squared*100:.2f}%\n\n"
                f"{coefficients_list}" 
            )
        }

    except Exception as e:
        # –í–æ–∑–≤—Ä–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ
        return {"error": f"–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Ä–∞—Å—á–µ—Ç. {str(e)}"}

# --- –ó–ê–ü–£–°–ö –°–ï–†–í–ï–†–ê ---
if __name__ == "__main__":
    uvicorn.run(app, host="0.0.0.0", port=5000)
